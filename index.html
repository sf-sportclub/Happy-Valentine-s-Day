<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentine Message Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Mali:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #fff0f5; 
        font-family: 'Kanit', sans-serif;
        background-image: radial-gradient(#ffb7c5 15%, transparent 16%), radial-gradient(#ffb7c5 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
      }

      /* --- Header --- */
      #main-header {
        position: absolute;
        top: 30px;
        width: 100%;
        text-align: center;
        font-family: 'Mali', cursive;
        font-size: 3rem;
        font-weight: 700;
        color: #ff1493;
        text-shadow: 3px 3px 0px rgba(255, 255, 255, 0.8), 0 0 10px rgba(255, 105, 180, 0.3);
        z-index: 10;
        pointer-events: none;
        user-select: none;
      }

      /* --- Floating/Chat Container --- */
      #floating-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 1;
      }

      .floating-msg {
        position: absolute;
        white-space: nowrap;
        padding: 12px 25px;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        font-size: 20px;
        font-family: 'Mali', cursive;
        color: #d63384;
        border: 2px solid #ff69b4;
        user-select: none;
        will-change: transform; 
        display: flex;
        flex-direction: column;
      }
      
      .sender-name { display: none; }
      .msg-content::before { content: '‚ù§Ô∏è '; }

      /* --- Input Area --- */
      #input-area {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 650px;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        display: flex;
        gap: 10px;
        z-index: 100;
        border: 3px solid #ff85a2;
        align-items: center;
        flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ counter ‡∏•‡∏á‡∏°‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
      }

      #nameInput {
        width: 20%;
        border: none;
        border-bottom: 2px solid #ffb7c5;
        outline: none;
        padding: 10px;
        font-size: 16px;
        font-family: 'Kanit', sans-serif;
        color: #ff69b4;
        background: transparent;
      }
      #nameInput::placeholder { color: #ffb7c5; }

      /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Input + Counter */
      .msg-input-wrapper {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
      }

      #msgInput {
        width: 100%;
        border: none;
        outline: none;
        padding: 10px;
        padding-right: 40px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö */
        font-size: 16px;
        font-family: 'Kanit', sans-serif;
        color: #333;
        background: transparent;
      }

      /* ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
      #charCounter {
        position: absolute;
        right: 5px;
        bottom: 5px;
        font-size: 10px;
        color: #ffb7c5;
        font-weight: bold;
        pointer-events: none;
      }
      #charCounter.warning { color: #ff0000; }

      .action-btn {
        background-color: #ff69b4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
        font-family: 'Kanit', sans-serif;
        white-space: nowrap;
      }
      .action-btn:hover { background-color: #ff1493; transform: scale(1.05); }
      .action-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

      #emojiBtn {
        background-color: #fff;
        border: 2px solid #ff69b4;
        color: #ff69b4;
        font-size: 20px;
        padding: 5px 12px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
      }
      #emojiBtn:hover { background-color: #ffeff5; transform: scale(1.1); }

      /* --- Emoji Picker --- */
      #emojiPicker {
        display: none;
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-30%);
        background: white;
        border: 2px solid #ffb7c5;
        border-radius: 15px;
        padding: 10px;
        width: 280px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 101;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
        max-height: 200px;
        overflow-y: auto;
      }
      #emojiPicker.show { display: flex; animation: popUp 0.3s ease-out; }
      .emoji-item { font-size: 24px; padding: 5px; cursor: pointer; transition: transform 0.1s; user-select: none; }
      .emoji-item:hover { transform: scale(1.3); }

      @keyframes popUp {
        from { opacity: 0; transform: translateX(-30%) translateY(10px); }
        to { opacity: 1; transform: translateX(-30%) translateY(0); }
      }

      /* --- Decorations --- */
      .decoration {
        position: absolute;
        font-size: 3rem;
        opacity: 0.8;
        z-index: 0;
        pointer-events: none;
        animation: float-dec 3s ease-in-out infinite;
      }
      .dec-tl { top: 20px; left: 20px; animation-delay: 0s; }
      .dec-tr { top: 20px; right: 20px; animation-delay: 1s; }
      .dec-bl { bottom: 100px; left: 30px; animation-delay: 0.5s; font-size: 2.5rem; }
      .dec-br { bottom: 100px; right: 30px; animation-delay: 1.5s; font-size: 2.5rem; }

      @keyframes float-dec {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(5deg); }
      }

      /* --- Mobile Styles --- */
      @media screen and (max-width: 768px) {
        body { background-size: 30px 30px; }
        #main-header { position: fixed; top: 0; padding: 10px 0; background: rgba(255, 240, 245, 0.95); font-size: 1.4rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .decoration { display: none; }

        #floating-container {
          position: fixed; top: 60px; bottom: 70px; left: 0; width: 100%; height: auto;
          overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column;
          padding: 10px; box-sizing: border-box; gap: 6px;
        }

        .floating-msg {
          position: relative !important; left: auto !important; top: auto !important; transform: none !important;
          white-space: normal; word-wrap: break-word; max-width: 75%; font-size: 14px; margin: 0;
          align-self: flex-start; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          padding: 8px 12px; border-radius: 15px;
        }

        .sender-name { display: block; font-size: 11px; color: #ff69b4; font-weight: 600; margin-bottom: 2px; }
        .floating-msg:nth-child(even) { align-self: flex-end; background-color: #ffeff5; border-color: #ffb7c5; }
        
        #input-area { width: 96%; bottom: 10px; padding: 6px; border-radius: 20px; }
        #nameInput { width: 50px; font-size: 14px; }
        #msgInput { font-size: 14px; }
        .action-btn { padding: 8px 15px; font-size: 14px; }
        
        #emojiPicker { left: 50%; transform: translateX(-50%); width: 90%; bottom: 60px; }
        @keyframes popUp {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
      }

      @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      .heart-particle { position: fixed; color: #ff1493; font-size: 20px; animation: floatUp 2s ease-out forwards; pointer-events: none; z-index: 999; }
      @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
    </style>
  </head>
  <body>

    <div id="main-header">SF Valentine Message Board üíñ</div>

    <div class="decoration dec-tl">üíå</div>
    <div class="decoration dec-tr">üß∏</div>
    <div class="decoration dec-bl">üåπ</div>
    <div class="decoration dec-br">üç´</div>

    <div id="floating-container"></div>

    <div id="input-area">
      <div id="emojiPicker"></div>

      <input type="text" id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠..." maxlength="20">
      
      <div class="msg-input-wrapper">
        <!-- Maxlength 120 ‡∏ï‡∏≤‡∏° Requirement -->
        <input type="text" id="msgInput" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." maxlength="120">
        <div id="charCounter">0/120</div>
      </div>
      
      <button id="emojiBtn" onclick="toggleEmojiPicker()">üòä</button>
      <button onclick="submitMessage()" id="sendBtn" class="action-btn">‡∏™‡πà‡∏á ‚ù§Ô∏è</button>
    </div>

    <script>
      // =========================================================
      // ‚ö†Ô∏è‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL ‡πÅ‡∏•‡∏∞ Token ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Google Apps Script ‚ö†Ô∏è‚ö†Ô∏è
      // =========================================================
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby8MuI4cpeOFEnf7Mv5iYCTDpmq_E1jKa4yd4ftcryrXxs9BDV3Mn0_AoUkq28dC6sY/exec"; 
      const API_TOKEN = 'MY_LOVE_TOKEN_2025'; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö .gs
      
      const MAX_MESSAGES = 30; 
      const MAX_CHARS = 120; // ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML maxlength

      let existingMessages = [];
      let floatingElements = [];
      let isMobile = false;
      let hasAlertedError = false;

      const emojis = [
        "‚ù§Ô∏è", "üíñ", "üíò", "üíù", "üíì", "üíó", "üíû", "üíï", "üíü", "‚ù£Ô∏è", 
        "üòç", "ü•∞", "üòò", "üòö", "üòª", "ü§©", "ü§™", "üòá", "ü•≥", "üòé",
        "üåπ", "üíê", "üå∑", "üåª", "üåº", "üå∏", "üå∫", "üç´", "üç¨", "üç≠",
        "üß∏", "üéÅ", "üéÄ", "üéà", "üéâ", "‚ú®", "üí´", "‚≠êÔ∏è", "üåô", "‚òÅÔ∏è"
      ];

      window.onload = function() {
        checkLayout(); 
        window.addEventListener('resize', checkLayout);
        
        createEmojiPicker();
        setupInputValidation(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Input

        if (WEB_APP_URL.includes("URL_‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å") || WEB_APP_URL === "") {
             alert("‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!");
             return;
        }

        fetchData(); 
        requestAnimationFrame(animateLoop);
        setInterval(fetchData, 4000);
      };

      // --- Input Validation & Counter ---
      function setupInputValidation() {
        const msgInput = document.getElementById('msgInput');
        const counter = document.getElementById('charCounter');

        msgInput.addEventListener('input', function() {
            const len = this.value.length;
            counter.innerText = `${len}/${MAX_CHARS}`;
            
            if (len >= MAX_CHARS) {
                counter.classList.add('warning');
            } else {
                counter.classList.remove('warning');
            }
        });
      }

      // --- XSS Protection (Sanitize Function) ---
      function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      function createEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.textContent = emoji;
            span.className = 'emoji-item';
            span.onclick = () => {
                const msgInput = document.getElementById('msgInput');
                if (msgInput.value.length < MAX_CHARS) {
                    msgInput.value += emoji;
                    // Trigger input event ‡πÄ‡∏û‡∏∑‡πà‡∏≠ update counter
                    msgInput.dispatchEvent(new Event('input')); 
                    msgInput.focus();
                }
            };
            picker.appendChild(span);
        });
      }

      function toggleEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        picker.classList.toggle('show');
      }

      document.addEventListener('click', function(event) {
        const picker = document.getElementById('emojiPicker');
        const btn = document.getElementById('emojiBtn');
        if (!picker.contains(event.target) && !btn.contains(event.target)) {
            picker.classList.remove('show');
        }
      });

      function checkLayout() {
        const wasMobile = isMobile;
        isMobile = window.innerWidth <= 768;
        if (wasMobile !== isMobile) {
          const container = document.getElementById('floating-container');
          const msgs = document.querySelectorAll('.floating-msg');
          if (isMobile) {
            msgs.forEach(el => { el.style.left = ''; el.style.top = ''; });
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
          }
        }
      }

      function fetchData() {
        if (WEB_APP_URL.includes("URL_‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å")) return;

        fetch(WEB_APP_URL)
          .then(response => {
             if (!response.ok) throw new Error("Network response was not ok");
             return response.json();
          })
          .then(data => {
            updateBoard(data);
            hasAlertedError = false;
          })
          .catch(error => {
            console.error('Error:', error);
            if (!hasAlertedError && error.name === "SyntaxError") {
                alert("‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡πÄ‡∏ä‡πá‡∏Ñ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Anyone");
                hasAlertedError = true;
            }
          });
      }

      function updateBoard(messages) {
        // Backend ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏ö‡∏ö Sorted ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Backend ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô [Newest, ..., Oldest]
        // ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π Timeline ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
        // Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏•‡∏≠‡∏¢‡πÜ ‡∏™‡∏∏‡πà‡∏°‡πÜ ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏™‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ Mobile Mode ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á
        
        // ‡∏ñ‡πâ‡∏≤ messages ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        if (messages.length > 0) {
           // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏á ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å Timestamp ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡πá‡∏Ñ length ‡∏Å‡πà‡∏≠‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ)
           // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Clear ‡πÅ‡∏•‡πâ‡∏ß Render ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ Append ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
           // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Floating Board ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
           
           // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Sort DESC ‡∏à‡∏≤‡∏Å Backend
           // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Filter ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà "Timestamp" ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ
           // ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Timestamp ‡πÄ‡∏õ‡πá‡∏ô String ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≤‡∏Å
           // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
           
           // Hack: ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Floating ‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤ ‡∏Å‡∏≤‡∏£ Re-render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
           // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ
           
           const latestMsg = messages[0]; // ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server
           const currentLatest = existingMessages[0]; // ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î Local
           
           // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Timestamp ‡∏´‡∏£‡∏∑‡∏≠ Text)
           if (!currentLatest || (latestMsg.timestamp !== currentLatest.timestamp)) {
                
                // ‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á (Diff) - ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Add ‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ Server ‡∏™‡πà‡∏á‡∏°‡∏≤ 50 ‡∏≠‡∏±‡∏ô ‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏à‡∏≠
                
                // Reverse ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ loop ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
                let incoming = [...messages].reverse(); 
                
                incoming.forEach(msgData => {
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô existingMessages ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏õ‡πá‡∏ô key ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ timestamp ‡πÉ‡∏ä‡πâ text+name ‡πÅ‡∏ó‡∏ô
                    const isExist = existingMessages.some(em => 
                        em.timestamp === msgData.timestamp && em.text === msgData.text
                    );
                    
                    if (!isExist) {
                        createFloatingText(msgData);
                    }
                });
                
                existingMessages = messages;
           }
        }
      }

      function createFloatingText(data) {
        if (floatingElements.length >= MAX_MESSAGES) {
            const oldest = floatingElements.shift(); 
            if (oldest && oldest.element) oldest.element.remove();
        }

        const container = document.getElementById('floating-container');
        const el = document.createElement('div');
        el.className = 'floating-msg';
        
        // XSS Protection ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const safeText = escapeHtml(data.text);
        const safeName = (data.name && data.name.trim() !== "") ? escapeHtml(data.name) : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô";
        
        el.innerHTML = `
          <div class="sender-name">${safeName}</div>
          <div class="msg-content">${safeText}</div>
        `;
        
        const startX = Math.random() * (window.innerWidth - 100);
        const startY = 100 + Math.random() * (window.innerHeight - 250); 
        
        if (!isMobile) {
            el.style.left = startX + 'px';
            el.style.top = startY + 'px';
        }
        
        container.appendChild(el);

        let speed = 0.4 + Math.random() * 0.8;
        let angle = Math.random() * Math.PI * 2;

        floatingElements.push({
          element: el,
          x: startX,
          y: startY,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          width: 0,
          height: 0
        });

        if (isMobile) {
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        }
      }

      function animateLoop() {
        if (!isMobile) {
            const containerW = window.innerWidth;
            const containerH = window.innerHeight;

            floatingElements.forEach(item => {
              if (item.width === 0) {
                item.width = item.element.offsetWidth;
                item.height = item.element.offsetHeight;
              }
              item.x += item.vx;
              item.y += item.vy;

              if (item.x <= 0 || item.x + item.width >= containerW) {
                item.vx *= -1;
                item.x = Math.max(0, Math.min(item.x, containerW - item.width));
              }
              if (item.y <= 0 || item.y + item.height >= containerH) {
                item.vy *= -1;
                item.y = Math.max(0, Math.min(item.y, containerH - item.height));
              }
              item.element.style.left = item.x + 'px';
              item.element.style.top = item.y + 'px';
            });
        }
        requestAnimationFrame(animateLoop);
      }

      function submitMessage() {
        if (WEB_APP_URL.includes("URL_‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å")) {
             alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");
             return;
        }

        const msgInput = document.getElementById('msgInput');
        const nameInput = document.getElementById('nameInput');
        const btn = document.getElementById('sendBtn');
        
        const text = msgInput.value.trim();
        const name = nameInput.value.trim();

        // Validation ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
        if (text === "") {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
            return;
        }
        if (text.length > MAX_CHARS) {
            alert(`‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${text.length}/${MAX_CHARS})`);
            return;
        }

        // Disable ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

        fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors', // ‡πÉ‡∏ä‡πâ no-cors ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web App (Fire and forget)
          headers: {
            'Content-Type': 'application/json'
          },
          // ‡∏™‡πà‡∏á Token ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
          body: JSON.stringify({ 
              text: text, 
              name: name,
              token: API_TOKEN 
          })
        })
        .then(() => {
          msgInput.value = "";
          // Reset counter
          document.getElementById('charCounter').innerText = `0/${MAX_CHARS}`;
          document.getElementById('charCounter').classList.remove('warning');
          
          btn.disabled = false;
          btn.innerText = "‡∏™‡πà‡∏á ‚ù§Ô∏è";
          msgInput.focus();
          createHeartEffect();
          
          document.getElementById('emojiPicker').classList.remove('show'); 
          setTimeout(fetchData, 1000);
        })
        .catch(err => {
          console.error(err);
          btn.disabled = false;
          btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á");
        });
      }

      document.getElementById('msgInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
          submitMessage();
        }
      });

      function createHeartEffect() {
        const heart = document.createElement('div');
        heart.innerText = 'üíñ';
        heart.className = 'heart-particle';
        heart.style.left = (window.innerWidth / 2) + 'px';
        heart.style.bottom = '80px';
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 2000);
      }
    </script>
  </body>
</html>
